# Quadra 项目文档

> 极简 macOS 待办事项应用 —— 零依赖、本地优先、秒开秒用

**Quadra** 源自 "Quadrant"（象限），体现其核心的四象限任务分类功能。

---

## 架构概览

```
┌─────────────────────────────────────────────┐
│                   Views                      │
│  ContentView (主界面、列表、搜索、统计)       │
│  TodoRow (单行任务、优先级、标签、编辑)       │
└──────────────────┬──────────────────────────┘
                   │ @StateObject
                   ▼
┌─────────────────────────────────────────────┐
│                TodoStore                     │
│  @Published todos: [Todo]                   │
│  @Published tags: [Tag]                     │
│  CRUD / 撤销重做 / 排序过滤 / 导入导出       │
└──────────────────┬──────────────────────────┘
                   │ Codable (原子写入)
                   ▼
┌─────────────────────────────────────────────┐
│              JSON File                       │
│  ~/Library/.../Quadra/data.json             │
└─────────────────────────────────────────────┘
```

**设计哲学**：三层架构，无中间件。TodoStore 同时承担状态管理和持久化。

---

## 目录结构

```
Quadra/
├── QuadraApp.swift         # 应用入口 + 菜单栏命令
├── Quadra.entitlements     # App Sandbox 配置
├── Notifications.swift     # 通知名称定义（菜单 ↔ 视图通信）
├── Assets.xcassets/        # 资源目录（图标、颜色等）
│   └── AppIcon.appiconset/ # 应用图标（16-1024pt 多尺寸）
├── Models/
│   ├── Todo.swift          # 任务模型（优先级、到期日期、排序、标签、四象限）
│   ├── TodoData.swift      # 数据容器（版本化 JSON 结构）
│   ├── Tag.swift           # 标签模型（名称、颜色）
│   └── Quadrant.swift      # 四象限枚举（艾森豪威尔矩阵）
├── Store/
│   └── TodoStore.swift     # 状态管理 + 持久化 + 撤销/重做
└── Views/
    ├── ContentView.swift   # 主界面（列表/四象限切换、搜索、过滤、统计）
    ├── TodoRow.swift       # 单行任务视图（交互、编辑、右键菜单）
    ├── QuadrantView.swift  # 四象限主视图（2x2 网格）
    └── QuadrantCard.swift  # 象限卡片组件（任务列表）
```

---

## 已实现功能

### 核心功能
- [x] 任务 CRUD（添加、编辑、删除、切换完成）
- [x] 优先级标记（高/中/低/无，颜色区分）
- [x] 到期日期设置（今天/明天/下周/自定义）
- [x] 标签系统（创建、分配、过滤）
- [x] 拖拽排序（同优先级内 `.onMove`）
- [x] 撤销/重做（50 步历史栈）

### 搜索与过滤
- [x] 实时搜索（标题关键词匹配）
- [x] 优先级过滤
- [x] 标签过滤
- [x] 待办/已完成分组显示

### 数据管理
- [x] JSON 文件持久化
- [x] 原子写入（tmp → backup → rename）
- [x] 数据导入（覆盖/合并模式）
- [x] 数据导出

### 界面交互
- [x] 深色模式支持
- [x] 多选操作（批量删除、切换状态）
- [x] 右键菜单（编辑、优先级、到期日期、标签）
- [x] 底部统计栏（待办数、已完成数、今日完成）

### 四象限分类
- [x] 艾森豪威尔矩阵视图（2x2 网格布局）
- [x] 任务自动分类（重要性 × 紧急性）
- [x] 视图切换（列表 ↔ 四象限，⌘⇧Q）
- [x] 象限内任务交互（切换完成、优先级指示）

---

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| ⌘N | 新建任务 |
| ⌘⌫ | 删除选中任务 |
| ⌘⏎ | 切换完成状态 |
| Enter | 编辑选中任务 |
| Esc | 取消编辑 |
| ⌘F | 聚焦搜索框 |
| ⌘Z | 撤销 |
| ⌘⇧Z | 重做 |
| ⌘⇧K | 清除所有已完成 |
| ⌘⇧Q | 切换视图模式（列表/四象限） |
| ⌘0/1/2/3 | 设置优先级（无/高/中/低） |
| ⌘I | 导入数据 |
| ⌘E | 导出数据 |

---

## 关键决策

| 领域 | 决策 | 理由 |
|------|------|------|
| Sandbox | 开启 | 系统管理容器路径，无需手动设置权限 |
| 存储 | JSON 文件 | 零依赖，Codable 原生支持，便于调试 |
| 日期格式 | ISO8601 UTC | 标准格式，跨时区安全 |
| 写入策略 | 原子替换 | tmp → backup → rename，防数据丢失 |
| 架构 | 三层极简 | View → Store → File，无过度抽象 |
| 排序 | sortOrder 字段 | 支持手动拖拽排序，优先级排序优先 |
| 选中交互 | 避免双击手势 | 双击手势会干扰 List 单击选中 |

---

## 数据存储

**位置**：`~/Library/Application Support/Quadra/`

```
data.json          # 主数据文件
data.json.backup   # 上次成功写入的备份
data.json.tmp      # 写入中的临时文件
```

**格式**：
```json
{
  "version": 1,
  "todos": [
    {
      "id": "uuid",
      "title": "任务标题",
      "isCompleted": false,
      "priority": "high",
      "dueDate": "2026-01-15T23:59:59Z",
      "sortOrder": 0,
      "tagIds": ["tag-uuid-1", "tag-uuid-2"],
      "createdAt": "2026-01-09T10:00:00Z",
      "completedAt": null,
      "updatedAt": "2026-01-09T10:00:00Z"
    }
  ],
  "tags": [
    {
      "id": "tag-uuid",
      "name": "工作",
      "color": "blue"
    }
  ]
}
```

---

## 开发规范

1. **零依赖原则**：仅使用系统内置框架（SwiftUI、Foundation）
2. **本地优先**：所有数据存储在本地，无需联网
3. **原子写入**：任何持久化操作必须保证数据完整性
4. **单一数据源**：TodoStore 持有唯一真相
5. **边界清晰**：View 只负责展示，Store 只负责逻辑
6. **手势谨慎**：避免使用会干扰 List 选中的手势（如双击）

---

## 构建环境

| 项目 | 要求 |
|------|------|
| macOS | 14.0 Sonoma+ |
| Xcode | 15.0+ |
| Swift | 5.9+ |
| 部署目标 | macOS 14.0 |

---

## 实施进度

- [x] Phase 0: 项目初始化
- [x] Phase 1: 数据模型层（Todo, Tag, Priority, TodoData）
- [x] Phase 2: 持久化层（原子写入、备份恢复）
- [x] Phase 3: 业务逻辑层（CRUD、撤销重做、排序过滤）
- [x] Phase 4: 视图层（ContentView、TodoRow）
- [x] Phase 5: 完整性验证
- [x] Phase 6: 扩展功能（优先级、到期日期、标签、导入导出）
- [x] Phase 7: 交互优化（搜索过滤、深色模式、拖拽排序）
- [x] Phase 8: 四象限分类（艾森豪威尔矩阵视图）

---

## Phase 8: 四象限分类 ✅

### 功能概述

实现艾森豪威尔矩阵（Eisenhower Matrix）四象限分类视图，按「重要性 × 紧急性」可视化任务分布。

```
        紧急                    不紧急
   ┌─────────────────┬─────────────────┐
重 │ 🔴 Q1           │ 🟠 Q2           │
要 │ 重要且紧急       │ 重要但不紧急     │
   │ → 立即执行       │ → 计划安排       │
   ├─────────────────┼─────────────────┤
不 │ 🟡 Q3           │ ⚪ Q4           │
重 │ 不重要但紧急     │ 不重要且不紧急   │
要 │ → 考虑委托       │ → 考虑删除       │
   └─────────────────┴─────────────────┘
```

### 分类逻辑

| 维度 | 字段 | 判断规则 |
|------|------|----------|
| 重要性 | `priority` | 高/中 = 重要，低/无 = 不重要 |
| 紧急性 | `dueDate` | ≤今天或已过期 = 紧急，>今天或无 = 不紧急 |

### 实施步骤

| 阶段 | 功能 | 状态 |
|------|------|------|
| 8.1 | 四象限数据模型扩展 | ✅ |
| 8.2 | 四象限视图页面 | ✅ |
| 8.3 | 页面导航与切换 | ✅ |
| 8.4 | 象限内任务交互 | ✅ |
| 8.5 | 快捷键与菜单支持 | ✅ |
| 8.6 | 单元测试 | ✅ |

### 新增文件

```
Quadra/
├── Models/
│   └── Quadrant.swift          # 四象限枚举
└── Views/
    ├── QuadrantView.swift      # 四象限主视图
    └── QuadrantCard.swift      # 象限卡片组件
```

### 新增快捷键

| 快捷键 | 功能 |
|--------|------|
| ⌘⇧Q | 切换四象限视图 |

---

## 已知问题与设计权衡

1. **拖拽排序仅在同优先级内有效**：因为排序逻辑先按优先级排序，跨优先级拖拽会被优先级排序覆盖
2. **编辑任务使用 Enter 键或右键菜单**：双击手势会干扰 List 的单击选中机制，已移除

---

*文档版本: v4.0 | 更新时间: 2026-01-11 (重命名为 Quadra)*
